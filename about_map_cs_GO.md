# "Бакет" и "Эвакуация бакета" в Мапе

## Что такое "Бакет"?

**Бакет** в контексте мапы (хэш-таблицы) — это контейнер или "корзина", где хранятся элементы с одинаковым хэш-значением после деления на размер массива бакетов.  

Когда ключи добавляются в мапу, их хэш вычисляется, а затем результат указывает, в какой бакет будет помещён элемент. Если несколько ключей попадают в один и тот же бакет (из-за одинакового остатка от деления), они хранятся там вместе.  

Бакет позволяет:

1. Сгруппировать элементы с похожими хэшами.
2. Решать коллизии (когда два разных ключа попадают в один бакет).  

Таким образом, бакеты — это основной механизм, который помогает организовать и быстро находить элементы в мапе.

## Что такое "Эвакуация бакета"

Эвакуация бакета в мапе Go происходит в процессе **реорганизации структуры данных** мапы, чтобы поддерживать её эффективность при росте или изменении количества элементов. Этот процесс называется **расширением (rehashing)** и выполняется в определённых ситуациях:

---

### 1. **Когда мапа заполняется до порогового значения**

- Если количество элементов в мапе становится слишком большим относительно количества бакетов (обычно, если коэффициент заполнения превышает ~6.5 записей на бакет), мапа автоматически увеличивает количество бакетов в два раза.
- Эвакуация означает перемещение существующих ключей в новую, более крупную таблицу с пересчётом их местоположения, чтобы распределение ключей оставалось равномерным.

---

### 2. **При удалении ключей**

- Go не сразу освобождает память, когда ключи удаляются. Если в бакете остаётся слишком много "мёртвых" записей, они могут быть реорганизованы или эвакуированы, чтобы снизить затраты на поиск элементов.

---

### 3. **При изменении внутренней структуры мапы**

- Go использует два уровня хэширования для уменьшения коллизий: основной бакет и дополнительную область (overflow buckets). Если количество переполнений бакетов становится слишком большим, это может вызвать эвакуацию для оптимизации структуры.

---

### 4. **В случае конкурентного использования мапы**

- В редких случаях, если мапа используется с незначительными конкурентными изменениями (например, при чтении и записи без синхронизации), может инициироваться эвакуация для предотвращения непредсказуемого поведения.

---

### Механизм эвакуации

- Каждый ключ пересчитывает своё новое местоположение на основе хэш-функции и нового размера бакетов.
- Старые бакеты постепенно копируются в новый массив бакетов в фоновом режиме, когда выполняются операции чтения/записи (постепенный перенос для снижения нагрузки).

---

Эвакуация обеспечивает баланс производительности мапы, предотвращая её деградацию при росте или изменении данных.
