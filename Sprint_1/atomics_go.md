# –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ mutex –∏ atomic

- **–í–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å**
    1. –∫–∞–∫ –∏ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞—Ç–æ–º–∏–∫–∏ (–≤ mutex –∏ WG)
    2. –ø–æ—á–µ–º—É –∞—Ç–æ–º–∏–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ —á–µ–º mutex + int

–ê—Ç–æ–º–∏–∫–∏ –≤ Go ‚Äî —ç—Ç–æ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –ø—Ä–∏–º–∏—Ç–∏–≤—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –ø–æ–∑–≤–æ–ª—è—é—â–∏–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏. –û–Ω–∏ –±—ã—Å—Ç—Ä–µ–µ mutex, —Ç–∞–∫ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–ø—Ä—è–º—É—é —Å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≥–æ—Ä—É—Ç–∏–Ω. Mutex –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Ç–æ–º–∏–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É.

---

## üîç –†–∞–∑–±–∏—Ä–∞–µ–º—Å—è —Å –∞—Ç–æ–º–∏–∫–∞–º–∏ –≤ Go

### üß© –ß—Ç–æ —Ç–∞–∫–æ–µ –∞—Ç–æ–º–∏–∫–∏?

–ê—Ç–æ–º–∏–∫–∏ (–ø–∞–∫–µ—Ç `sync/atomic`) ‚Äî —ç—Ç–æ –Ω–∞–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–∞–º—è—Ç—å—é. "–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å" –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º, –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –¥—Ä—É–≥–∏–º–∏ –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏.

```go
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞—Ç–æ–º–∏–∫–∞
package main

import (
    "fmt"
    "sync/atomic"
    "time"
)

func main() {
    // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    var counter int64 = 0
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º 5 –≥–æ—Ä—É—Ç–∏–Ω, –∫–æ—Ç–æ—Ä—ã–µ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Å—á–µ—Ç—á–∏–∫
    for i := 0; i < 5; i++ {
        go func() {
            for j := 0; j < 1000; j++ {
                // üöÄ –ê—Ç–æ–º–∞—Ä–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                atomic.AddInt64(&counter, 1)
                // –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ: counter++ –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!
                time.Sleep(time.Microsecond)
            }
        }()
    }
    
    // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–æ—Ä—É—Ç–∏–Ω
    time.Sleep(time.Second * 2)
    
    // üìä –ë–µ–∑–æ–ø–∞—Å–Ω–æ —á–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
    fmt.Println("–ò—Ç–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:", atomic.LoadInt64(&counter))
}
```

### üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å Mutex

```go
package main

import (
    "fmt"
    "sync"
    "time"
)

func main() {
    var counter int64 = 0
    var mutex sync.Mutex // üîí –û–±—ä—è–≤–ª—è–µ–º –º—å—é—Ç–µ–∫—Å
    
    for i := 0; i < 5; i++ {
        go func() {
            for j := 0; j < 1000; j++ {
                mutex.Lock()   // üîí –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –¥—Ä—É–≥–∏–º –≥–æ—Ä—É—Ç–∏–Ω–∞–º
                counter++      // –ò–∑–º–µ–Ω—è–µ–º —Å—á–µ—Ç—á–∏–∫
                mutex.Unlock() // üîì –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –¥–ª—è –¥—Ä—É–≥–∏—Ö
                time.Sleep(time.Microsecond)
            }
        }()
    }
    
    time.Sleep(time.Second * 2)
    
    mutex.Lock()
    fmt.Println("–ò—Ç–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:", counter)
    mutex.Unlock()
}
```

## üí° –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è

### 1Ô∏è‚É£ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –∞—Ç–æ–º–∏–∫–∏?

–ê—Ç–æ–º–∏–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π (–∫–∞–∫ XCHG –≤ –ø—Ä–∏–º–µ—Ä–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞), –∫–æ—Ç–æ—Ä—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –±—É–¥–µ—Ç –ø—Ä–µ—Ä–≤–∞–Ω–∞ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≥–æ—Ä—É—Ç–∏–Ω.

### 2Ô∏è‚É£ –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞—Ç–æ–º–∏–∫–∏

üîπ **–í Mutex**: –ö–∞–∫ –≤–∏–¥–Ω–æ –∏–∑ –∫–æ–¥–∞ –≤ —Ç–≤–æ–µ–º –ø—Ä–∏–º–µ—Ä–µ, Mutex –≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Ç–æ–º–∏–∫–∏:

```go
// –í –º–µ—Ç–æ–¥–µ Lock –º—å—é—Ç–µ–∫—Å–∞
if atomic.CompareAndSwapInt32(&m.state, 0, mutexLocked) {
    // –ë—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å: –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ –Ω–µ–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º—å—é—Ç–µ–∫—Å
    return
}
```

üîπ **–í WaitGroup**: WaitGroup —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Ç–æ–º–∏–∫–∏ –¥–ª—è —Å—á–µ—Ç—á–∏–∫–∞ –æ–∂–∏–¥–∞–µ–º—ã—Ö –≥–æ—Ä—É—Ç–∏–Ω:

```go
// –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞—Ç–æ–º–∏–∫–æ–≤ –≤ WaitGroup
atomic.AddInt32(&wg.counter, 1) // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Add(1)
atomic.AddInt32(&wg.counter, -1) // –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Done()
```

### 3Ô∏è‚É£ –ü–æ—á–µ–º—É –∞—Ç–æ–º–∏–∫–∏ –±—ã—Å—Ç—Ä–µ–µ Mutex?

#### üöÄ –°–∫–æ—Ä–æ—Å—Ç—å –∏ –æ–≤–µ—Ä—Ö–µ–¥

1. **–ê—Ç–æ–º–∏–∫–∏**:
   - –†–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ (–æ–¥–Ω–∞-–¥–≤–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
   - –ù–µ —Ç—Ä–µ–±—É—é—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≥–æ—Ä—É—Ç–∏–Ω
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–≤–µ—Ä—Ö–µ–¥

2. **Mutex**:
   - –ò–º–µ–µ—Ç —Å–ª–æ–∂–Ω—É—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ª–æ–≥–∏–∫—É
   - –ü—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Ä—É—Ç–∏–Ω—ã (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞!)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ Go –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π

## üîç –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É –∞—Ç–æ–º–∏–∫–∞–º–∏ –∏ mutex

```go
package main

import (
    "fmt"
    "sync"
    "sync/atomic"
    "time"
)

func main() {
    // –¢–µ—Å—Ç —Å –∞—Ç–æ–º–∏–∫–∞–º–∏
    var atomicCounter int64 = 0
    startTime := time.Now()
    
    var wg sync.WaitGroup
    for i := 0; i < 100; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            for j := 0; j < 10000; j++ {
                // üöÄ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Ç–æ–º–∏–∫
                atomic.AddInt64(&atomicCounter, 1)
            }
        }()
    }
    wg.Wait()
    atomicTime := time.Since(startTime)
    
    // –¢–µ—Å—Ç —Å mutex
    var mutexCounter int64 = 0
    var mutex sync.Mutex
    startTime = time.Now()
    
    for i := 0; i < 100; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            for j := 0; j < 10000; j++ {
                // üîí –ò—Å–ø–æ–ª—å–∑—É–µ–º mutex
                mutex.Lock()
                mutexCounter++
                mutex.Unlock()
            }
        }()
    }
    wg.Wait()
    mutexTime := time.Since(startTime)
    
    fmt.Println("‚úÖ –ê—Ç–æ–º–∏–∫–∏:", atomicCounter, "–í—Ä–µ–º—è:", atomicTime)
    fmt.Println("üîí Mutex:", mutexCounter, "–í—Ä–µ–º—è:", mutexTime)
    fmt.Println("‚ö° –†–∞–∑–Ω–∏—Ü–∞ –≤ —Å–∫–æ—Ä–æ—Å—Ç–∏:", float64(mutexTime)/float64(atomicTime), "—Ä–∞–∑")
}
```

## ‚ö†Ô∏è –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∏–∫–∏, –∞ –∫–æ–≥–¥–∞ mutex?

### –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞—Ç–æ–º–∏–∫–∏, –∫–æ–≥–¥–∞

- üìå –ù—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å –æ–¥–Ω—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é (—Å—á–µ—Ç—á–∏–∫, —Ñ–ª–∞–≥)
- üìå –ö—Ä–∏—Ç–∏—á–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- üìå –û–ø–µ—Ä–∞—Ü–∏–∏ –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ

### –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ mutex, –∫–æ–≥–¥–∞

- üìå –ù—É–∂–Ω–æ –∑–∞—â–∏—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–π –∏–ª–∏ —Å–ª–æ–∂–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
- üìå –ö–æ–¥ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º
- üìå –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞—â–∏—Ç–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ä–µ—Å—É—Ä—Å—É, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —É–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫

## üåü –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ê—Ç–æ–º–∏–∫–∏ ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ Go, –Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç—å—é –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è. –û–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ mutex –∏ WaitGroup, –¥–µ–ª–∞—è —ç—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º–∏, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º —Å–∞–º–∏ –∞—Ç–æ–º–∏–∫–∏ –ø–æ–¥—Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏.

