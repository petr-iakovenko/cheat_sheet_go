# Graceful Shutdown

–°—Ç–∞—Ç—å—è –Ω–∞ —Ö–∞–±—Ä–µ - [—Å—Å—ã–ª–∫–∞](https://habr.com/ru/articles/771626/)

Graceful Shutdown –≤ Go ‚Äì —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∫–æ–≥–¥–∞ –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è. –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–Ω–∞–ª—ã, –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

# üöÄ –ü–æ–Ω—è—Ç–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ Graceful Shutdown –≤ Go

## üîç –ß—Ç–æ —Ç–∞–∫–æ–µ Graceful Shutdown?

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ —É –≤–∞—Å —Ä–µ—Å—Ç–æ—Ä–∞–Ω, –∏ –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å—Å—è. –ì—Ä—É–±—ã–π —Å–ø–æ—Å–æ–±: –≤—ã–≥–Ω–∞—Ç—å –≤—Å–µ—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ. Graceful —Å–ø–æ—Å–æ–±: –¥–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º –¥–æ–µ—Å—Ç—å, –Ω–æ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–æ–≤—ã—Ö.

–í –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–æ –∂–µ —Å–∞–º–æ–µ:

- ‚úÖ –î–∞—Ç—å —Ç–µ–∫—É—â–∏–º –æ–ø–µ—Ä–∞—Ü–∏—è–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, HTTP-–∑–∞–ø—Ä–æ—Å–∞–º) –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è
- ‚úÖ –ù–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

## ‚ùå –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã: –∫–∞–∫ –ù–ï –Ω–∞–¥–æ –¥–µ–ª–∞—Ç—å

### 1Ô∏è‚É£ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ os.Exit()

```go
go func() {
    <-—Å–∏–≥–Ω–∞–ª 
    os.Exit(1) // ‚ùå –ü–õ–û–•–û: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
}()
```

–≠—Ç–æ –∫–∞–∫ –≤—ã–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä, –≤—ã–¥–µ—Ä–Ω—É–≤ —à–Ω—É—Ä –∏–∑ —Ä–æ–∑–µ—Ç–∫–∏. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.

### 2Ô∏è‚É£ –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã

```go
func –î–µ—Ä–∂–∞—Ç—å–ü—Ä–æ—Ü–µ—Å—Å–ñ–∏–≤—ã–º() {
    var –∫–∞–Ω–∞–ª chan int
    <-–∫–∞–Ω–∞–ª // ‚ùå –ü–õ–û–•–û: –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
}
```

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥: —à–∞–≥ –∑–∞ —à–∞–≥–æ–º

### üîÑ –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

```go
package main

import (
    "fmt"
    "os"
    "os/signal"
    "syscall"
    "time"
)

func main() {
    // üîÑ –°–æ–∑–¥–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª –¥–ª—è —Å–∏–≥–Ω–∞–ª–æ–≤ –û–°
    —Å–∏–≥–Ω–∞–ª—ã := make(chan os.Signal, 1) // –±—É—Ñ–µ—Ä –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å–∏–≥–Ω–∞–ª–∞
    
    // üîÑ –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–∏–≥–Ω–∞–ª—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (Ctrl+C –∏ SIGTERM)
    signal.Notify(—Å–∏–≥–Ω–∞–ª—ã, os.Interrupt, syscall.SIGTERM)
    
    // –î–∞–ª—å—à–µ –±—É–¥–µ—Ç –∫–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —ç—Ç–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤...
}
```

### üîÑ –®–∞–≥ 2: –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä —Å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º —Ü–∏–∫–ª–æ–º

```go
func main() {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤ (–∫–∞–∫ –≤—ã—à–µ)
    —Å–∏–≥–Ω–∞–ª—ã := make(chan os.Signal, 1)
    signal.Notify(—Å–∏–≥–Ω–∞–ª—ã, os.Interrupt, syscall.SIGTERM)
    
    // –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤—ã—Ö–æ–¥–∞
    for {
        select {
        case <-—Å–∏–≥–Ω–∞–ª—ã:
            // üéØ –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            fmt.Println("‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É")
            return // –≤—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã
        case <-time.After(1 * time.Second):
            // –û–±—ã—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã
            fmt.Println("–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç...")
        }
    }
}
```

### üîÑ –®–∞–≥ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≥–æ—Ä—É—Ç–∏–Ω

```go
func main() {
    // üì¢ –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å
    ctx, –æ—Ç–º–µ–Ω–∞ := context.WithCancel(context.Background())
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–∏–≥–Ω–∞–ª–æ–≤
    —Å–∏–≥–Ω–∞–ª—ã := make(chan os.Signal, 1)
    signal.Notify(—Å–∏–≥–Ω–∞–ª—ã, os.Interrupt, syscall.SIGTERM)
    
    // –ì–æ—Ä—É—Ç–∏–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–∏–≥–Ω–∞–ª—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    go func() {
        <-—Å–∏–≥–Ω–∞–ª—ã
        fmt.Println("‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏")
        –æ—Ç–º–µ–Ω–∞() // üî• –û—Ç–º–µ–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç - —ç—Ç–æ —Å–∏–≥–Ω–∞–ª –í–°–ï–ú –≥–æ—Ä—É—Ç–∏–Ω–∞–º
    }()
    
    // üßµ –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –≥–æ—Ä—É—Ç–∏–Ω
    var wg sync.WaitGroup
    
    // üßµ –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é –≥–æ—Ä—É—Ç–∏–Ω—É
    wg.Add(1)
    go func() {
        defer wg.Done() // üîç –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –≥–æ—Ä—É—Ç–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞ —Ä–∞–±–æ—Ç—É
        for {
            select {
            case <-ctx.Done(): // üëÇ –°–ª—É—à–∞–µ–º —Å–∏–≥–Ω–∞–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                fmt.Println("–ì–æ—Ä—É—Ç–∏–Ω–∞ 1 –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É")
                return
            case <-time.After(1 * time.Second):
                fmt.Println("–ì–æ—Ä—É—Ç–∏–Ω–∞ 1 —Ä–∞–±–æ—Ç–∞–µ—Ç...")
            }
        }
    }()
    
    // üßµ –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Ç–æ—Ä—É—é –≥–æ—Ä—É—Ç–∏–Ω—É
    wg.Add(1)
    go func() {
        defer wg.Done()
        for {
            select {
            case <-ctx.Done():
                fmt.Println("–ì–æ—Ä—É—Ç–∏–Ω–∞ 2 –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É")
                return
            case <-time.After(1 * time.Second):
                fmt.Println("–ì–æ—Ä—É—Ç–∏–Ω–∞ 2 —Ä–∞–±–æ—Ç–∞–µ—Ç...")
            }
        }
    }()
    
    // üßµ –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –í–°–ï–• –≥–æ—Ä—É—Ç–∏–Ω
    wg.Wait()
    fmt.Println("‚úÖ –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
}
```

### üéÆ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏ –ø—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Ö–æ–¥ (Go 1.16+)

```go
func main() {
    // üåü –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω–∏—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–∞
    ctx, —Å—Ç–æ–ø := signal.NotifyContext(context.Background(), os.Interrupt, syscall.SIGTERM)
    defer —Å—Ç–æ–ø() // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤
    
    var wg sync.WaitGroup
    
    // –î–∞–ª—å—à–µ –≤—Å—ë –∫–∞–∫ —Ä–∞–Ω—å—à–µ - –∑–∞–ø—É—Å–∫–∞–µ–º –≥–æ—Ä—É—Ç–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—É—à–∞—é—Ç ctx.Done()
    wg.Add(1)
    go func() {
        defer wg.Done()
        for {
            select {
            case <-ctx.Done():
                fmt.Println("‚ö†Ô∏è –ì–æ—Ä—É—Ç–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É")
                return
            case <-time.After(1 * time.Second):
                fmt.Println("–ì–æ—Ä—É—Ç–∏–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç...")
            }
        }
    }()
    
    wg.Wait()
    fmt.Println("‚úÖ –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
}
```

## üìù –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è

### 1Ô∏è‚É£ –ö–∞–Ω–∞–ª—ã –∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è

```go
—Å–∏–≥–Ω–∞–ª—ã := make(chan os.Signal, 1) // –° –±—É—Ñ–µ—Ä–æ–º —Ä–∞–∑–º–µ—Ä–∞ 1
```

üîç **–ó–∞—á–µ–º –Ω—É–∂–µ–Ω –±—É—Ñ–µ—Ä?** –ë–µ–∑ –±—É—Ñ–µ—Ä–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —Å–∏–≥–Ω–∞–ª–∞ (–û–°) –±—É–¥–µ—Ç –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –∫—Ç–æ-—Ç–æ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–µ—Ç –∏–∑ –∫–∞–Ω–∞–ª–∞. –° –±—É—Ñ–µ—Ä–æ–º —Å–∏–≥–Ω–∞–ª –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–Ω—è—Ç–∞.

### 2Ô∏è‚É£ –ö–æ–Ω—Ç–µ–∫—Å—Ç - –∫–ª—é—á –∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏

```go
ctx, –æ—Ç–º–µ–Ω–∞ := context.WithCancel(context.Background())
// –ò–ª–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
ctx, —Å—Ç–æ–ø := signal.NotifyContext(context.Background(), os.Interrupt)
```

üîç **–ß—Ç–æ —Ç–∞–∫–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç?** –≠—Ç–æ –∫–∞–∫ –æ–±—â–∏–π –≤—ã–∫–ª—é—á–∞—Ç–µ–ª—å –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ä—É—Ç–∏–Ω. –ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—à—å `–æ—Ç–º–µ–Ω–∞()`, –≤—Å–µ, –∫—Ç–æ —Å–ª—É—à–∞–µ—Ç `ctx.Done()`, —É–∑–Ω–∞—é—Ç –æ–± —ç—Ç–æ–º.

### 3Ô∏è‚É£ WaitGroup - –¥–æ–∂–¥–∞—Ç—å—Å—è –≤—Å–µ—Ö

```go
var wg sync.WaitGroup
wg.Add(1) // –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≥–æ—Ä—É—Ç–∏–Ω
// ...–≤ –≥–æ—Ä—É—Ç–∏–Ω–µ
defer wg.Done() // –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫
// ...–≤ main
wg.Wait() // –ñ–¥–µ–º, –ø–æ–∫–∞ —Å—á–µ—Ç—á–∏–∫ –Ω–µ —Å—Ç–∞–Ω–µ—Ç 0
```

üîç **–ó–∞—á–µ–º –Ω—É–∂–µ–Ω WaitGroup?** –ß—Ç–æ–±—ã main –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Ä–∞–Ω—å—à–µ, —á–µ–º –≤—Å–µ –≥–æ—Ä—É—Ç–∏–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫–æ–Ω—á–∞—Ç —Ä–∞–±–æ—Ç—É.

## üåü –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: HTTP-—Å–µ—Ä–≤–µ—Ä —Å Graceful Shutdown

```go
package main

import (
    "context"
    "fmt"
    "net/http"
    "os"
    "os/signal"
    "sync"
    "syscall"
    "time"
)

func main() {
    // üåü –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ—Ç–º–µ–Ω—ã
    ctx, —Å—Ç–æ–ø := signal.NotifyContext(context.Background(), os.Interrupt, syscall.SIGTERM)
    defer —Å—Ç–æ–ø()
    
    // üåê –°–æ–∑–¥–∞–µ–º HTTP-—Å–µ—Ä–≤–µ—Ä
    —Å–µ—Ä–≤–µ—Ä := &http.Server{
        Addr: ":8080",
        Handler: http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
            // üîÑ –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –≥–ª–∞–≤–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            ctx := r.Context()
            
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –¥–æ–ª–≥—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
            fmt.Println("üöÄ –ù–∞—á–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...")
            
            select {
            case <-ctx.Done():
                // –ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è)
                fmt.Println("‚ö†Ô∏è –ó–∞–ø—Ä–æ—Å –ø—Ä–µ—Ä–≤–∞–Ω")
                return
            case <-time.After(5 * time.Second):
                // –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                fmt.Println("‚úÖ –ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω")
                fmt.Fprintf(w, "–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!")
            }
        }),
        // –°–≤—è–∑—ã–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –Ω–∞—à–∏–º –≥–ª–∞–≤–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        BaseContext: func(_ any) context.Context {
            return ctx
        },
    }
    
    // –°–æ–∑–¥–∞–µ–º WaitGroup –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–æ—Ä—É—Ç–∏–Ω
    var wg sync.WaitGroup
    
    // üßµ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ
    wg.Add(1)
    go func() {
        defer wg.Done()
        
        fmt.Println("üåê –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:8080")
        // ListenAndServe –±–ª–æ–∫–∏—Ä—É–µ—Ç –≥–æ—Ä—É—Ç–∏–Ω—É, –ø–æ–∫–∞ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
        err := —Å–µ—Ä–≤–µ—Ä.ListenAndServe()
        
        if err != nil && err != http.ErrServerClosed {
            // –≠—Ç–æ –Ω–∞—Å—Ç–æ—è—â–∞—è –æ—à–∏–±–∫–∞, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–∏–≥–Ω–∞–ª –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
            fmt.Printf("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: %v\n", err)
        }
    }()
    
    // üßµ –ñ–¥–µ–º —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ
    wg.Add(1)
    go func() {
        defer wg.Done()
        
        // –ñ–¥–µ–º —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        <-ctx.Done()
        
        fmt.Println("\n‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –Ω–∞—á–∏–Ω–∞–µ–º graceful shutdown...")
        
        // –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å —Ç–∞–π–º–∞—É—Ç–æ–º –¥–ª—è shutdown
        // –ï—Å–ª–∏ shutdown –∑–∞—Ç—è–Ω–µ—Ç—Å—è –±–æ–ª—å—à–µ —á–µ–º –Ω–∞ 10 —Å–µ–∫—É–Ω–¥, –æ–Ω –±—É–¥–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω
        shutdownCtx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
        defer cancel()
        
        // üõë –ó–∞–ø—É—Å–∫–∞–µ–º graceful shutdown —Å–µ—Ä–≤–µ—Ä–∞
        if err := —Å–µ—Ä–≤–µ—Ä.Shutdown(shutdownCtx); err != nil {
            fmt.Printf("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ graceful shutdown: %v\n", err)
        } else {
            fmt.Println("‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        }
    }()
    
    // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –≥–æ—Ä—É—Ç–∏–Ω
    wg.Wait()
    fmt.Println("üëã –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
}
```

## üìö –ö–æ–≥–¥–∞ –∏ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

1. **–ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ –≥–æ—Ä—É—Ç–∏–Ω**: –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ select.

2. **–ù–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä—É—Ç–∏–Ω**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç + WaitGroup.

3. **HTTP-—Å–µ—Ä–≤–µ—Ä**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `Shutdown` –≤–º–µ—Å—Ç–µ —Å context –∏ WaitGroup.

4. **–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏** (–ë–î –∏ —Ç.–¥.): –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ "–æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è –∫ –Ω–∏–∂–Ω–µ–º—É".

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Graceful Shutdown - —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫—Ä–∞—Å–∏–≤–∞—è —Ñ—Ä–∞–∑–∞, –∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã:

- üõ°Ô∏è –ó–∞—â–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è
- üîÑ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–µ—Ä—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- üëç –£–ª—É—á—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç
- üß© –°–Ω–∏–∂–∞–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏
